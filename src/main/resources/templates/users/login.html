<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"  >
    
    <link rel="stylesheet"  href="../../resources/css/login.css"    
 type="text/css" /> 
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Login</title>
     
</head>
<body>

    <!----------------------- Main Container -------------------------->

     <div class="container d-flex justify-content-center align-items-center min-vh-100">

    <!----------------------- Login Container -------------------------->

       <div class="row border rounded-5 p-3 bg-white shadow box-area">

    <!--------------------------- Left Box ----------------------------->

       <div class="col-md-6 rounded-4 d-flex justify-content-center align-items-center flex-column left-box" style="background: #6588f1;">
           <div class="featured-image mt-1 mb-2">
            <img th:src="@{classpath:/static/images/imgclothes.jpg}" class="img-fluid" style="width: 250px; border-radius: 20px;">
           </div>
           <p class="text-white fs-3" style="font-family: 'Courier New', Courier, monospace; font-weight: 600;">NÓI GÌ ĐÓ ĐI</p>
           <small class="text-white text-wrap text-center" style="width: 20rem;margin-bottom: 5px;font-family: 'Courier New', Courier, monospace;">Join us.....</small>
       </div> 

    <!-------------------- ------ Right Box ---------------------------->
        
       <div class="col-md-6 right-box">
          <div class="row align-items-center">
                <div class="header-text mb-4">
                     <h2>Login</h2>
                     <p> cho vào 1 câu nói nào đó </p>
                </div>
                <form th:id="login-form" th:action="@{/user/checkLogin}" method="POST"
		th:object="${loginRequestDto}">
                	 <div class="input-group mb-3">
                    	<input th:id="email-input" th:field="*{email}" type="text" class="form-control form-control-lg bg-light fs-6" placeholder="Email address">
                    	<div th:id="email-error"></div>
                	</div>
                	<div class="input-group mb-1">
                    	<input th:id="password-input" th:field="*{password}" type="password" class="form-control form-control-lg bg-light fs-6" placeholder="Password">
                    	<div th:id="password-error"></div>
               		</div>
                	<div class="input-group mb-5 d-flex justify-content-between">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="formCheck">
                        <label for="formCheck" class="form-check-label text-secondary"><small>Remember Me</small></label>
                    </div>
                    <div class="forgot">
                        <small><a href="#">Forgot Password?</a></small>
                    </div>
                	</div>
                	<div class="input-group mb-3">
                    	<button th:id="login-button" class="btn btn-lg btn-primary w-100 fs-6">Login</button>
                	</div>
                </form>
               
                <div class="input-group mb-3">
                    <button class="btn btn-lg btn-light w-100 fs-6"><img src="../static/images/google.png" style="width:20px" class="me-2"><small>Sign In with Google</small></button>
                </div>
                <div class="row">
                    <small>Don't have account? <a href="../templates/register.html">Register</a></small>
                </div>
          </div>
       </div> 

      </div>
    </div>
	<script>
		const loginForm = document.getElementById('login-form');
	const emailInput = document.getElementById('email-input');
	const passwordInput = document.getElementById('password-input');
	const emailError =document.getElementById('email-error');
	const passwordError =document.getElementById('password-error');
	
	//if user forcus input is set value error empty
	
	
	loginForm.addEventListener('submit', async (event) => {
	  event.preventDefault();
	  emailInput.addEventListener("focus", function() {
		  emailError.textContent = ""; 
		});
	passwordInput.addEventListener("focus", function() {
		passwordError.textContent = ""; 
		});
	  const formData = new FormData(loginForm);
	  const email = formData.get('email');
	  const password = formData.get('password');
	  
	  //check username or email is empty
	  function isEmpty(str) {
		  return (!str || str.length === 0);
	  }
	  var isValid = true;
	  function validateForm(){
		 if (isEmpty(email)) {
			  // Hiển thị thông báo lỗi cho người dùng
			  emailError.textContent = 'Please enter your email!';
			  isValid = false;
		}

		if (isEmpty(password)) {
			  // Hiển thị thông báo lỗi cho người dùng
			  passwordError.textContent = 'Please enter your password!';
			  isValid = false;
		}
		return isValid;
	  }
	  
	  //if username or email is not empty call /user/checkLogin
		if(validateForm()){
			const response = await fetch('/user/checkLogin', {
			    method: 'POST',
			    headers: {
			      'Content-Type': 'application/json'
			    },
			    body: JSON.stringify({
			      email: email,
			      password: password
			    })
			  });
			//if the authentication is successful, add token in header 
			  if (response.ok) {
				  
				 const data = await response.json();
			     const token = data.token;
			     const role = data.role;
			     
			      const homeResponse = await fetch('/user/home', {
			        headers: {
			          'Authorization': 'Bearer ' + token
			        }
			      });
			      
			      const homeAdminResponse = await fetch('/user/homeAdmin', {
				        headers: {
				          'Authorization': 'Bearer ' + token
				        }
				      });
			
			      if (homeResponse.ok) {
			        if (role === 'USER') {
			          window.location.href = "/user/home";
			        } else if (role === 'ADMIN') {
			          window.location.href = '/user/homeAdmin';
			        }
			      } else {
			        alert('Log in failed!');
			      }
			  
			  } else {
			    alert("Email or password not match! Please try again!");
			  }
		}
	});
	</script>
</body>
</html>